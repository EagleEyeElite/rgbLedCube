/*
 * display.c
 *
 * Created: 02.09.2018 18:57:36
 *  Author: Conrad
 */

#include "driver/layerMosfets.h"
#include "driver/usart.h"
#include "driver/timer1.h"
#include "driver/tlc5940.h"
#include "driver/timer0.h"
#include "display.h"


static rawLayerData rawDisplayData[3];

void startDisplay() {
    initDisplayLayerMosfets();
    initTlc5940();
    initDisplayDataTransmitter(rawDisplayData);
    startGSCLK();
    startLayerSwitching();
}

void disableDisplay() {
    disableDisplayLayerMosfets();
    disableTlc5940();
    disableDisplayDataTransmitter();
    stopGSCLK();
    stopLayerSwitching();
}

// look up table:
// linear
static const uint16_t lightness[0x100] =
        {0x000, 0x010, 0x020, 0x030, 0x040, 0x050, 0x060, 0x070, 0x080, 0x091, 0x0a1, 0x0b1, 0x0c1, 0x0d1, 0x0e1, 0x0f1,
         0x101, 0x111, 0x121, 0x131, 0x141, 0x151, 0x161, 0x171, 0x181, 0x191, 0x1a2, 0x1b2, 0x1c2, 0x1d2, 0x1e2, 0x1f2,
         0x202, 0x212, 0x222, 0x232, 0x242, 0x252, 0x262, 0x272, 0x282, 0x292, 0x2a2, 0x2b3, 0x2c3, 0x2d3, 0x2e3, 0x2f3,
         0x303, 0x313, 0x323, 0x333, 0x343, 0x353, 0x363, 0x373, 0x383, 0x393, 0x3a3, 0x3b3, 0x3c4, 0x3d4, 0x3e4, 0x3f4,
         0x404, 0x414, 0x424, 0x434, 0x444, 0x454, 0x464, 0x474, 0x484, 0x494, 0x4a4, 0x4b4, 0x4c4, 0x4d5, 0x4e5, 0x4f5,
         0x505, 0x515, 0x525, 0x535, 0x545, 0x555, 0x565, 0x575, 0x585, 0x595, 0x5a5, 0x5b5, 0x5c5, 0x5d5, 0x5e6, 0x5f6,
         0x606, 0x616, 0x626, 0x636, 0x646, 0x656, 0x666, 0x676, 0x686, 0x696, 0x6a6, 0x6b6, 0x6c6, 0x6d6, 0x6e6, 0x6f7,
         0x707, 0x717, 0x727, 0x737, 0x747, 0x757, 0x767, 0x777, 0x787, 0x797, 0x7a7, 0x7b7, 0x7c7, 0x7d7, 0x7e7, 0x7f7,
         0x808, 0x818, 0x828, 0x838, 0x848, 0x858, 0x868, 0x878, 0x888, 0x898, 0x8a8, 0x8b8, 0x8c8, 0x8d8, 0x8e8, 0x8f8,
         0x908, 0x919, 0x929, 0x939, 0x949, 0x959, 0x969, 0x979, 0x989, 0x999, 0x9a9, 0x9b9, 0x9c9, 0x9d9, 0x9e9, 0x9f9,
         0xa09, 0xa19, 0xa2a, 0xa3a, 0xa4a, 0xa5a, 0xa6a, 0xa7a, 0xa8a, 0xa9a, 0xaaa, 0xaba, 0xaca, 0xada, 0xaea, 0xafa,
         0xb0a, 0xb1a, 0xb2a, 0xb3b, 0xb4b, 0xb5b, 0xb6b, 0xb7b, 0xb8b, 0xb9b, 0xbab, 0xbbb, 0xbcb, 0xbdb, 0xbeb, 0xbfb,
         0xc0b, 0xc1b, 0xc2b, 0xc3b, 0xc4c, 0xc5c, 0xc6c, 0xc7c, 0xc8c, 0xc9c, 0xcac, 0xcbc, 0xccc, 0xcdc, 0xcec, 0xcfc,
         0xd0c, 0xd1c, 0xd2c, 0xd3c, 0xd4c, 0xd5d, 0xd6d, 0xd7d, 0xd8d, 0xd9d, 0xdad, 0xdbd, 0xdcd, 0xddd, 0xded, 0xdfd,
         0xe0d, 0xe1d, 0xe2d, 0xe3d, 0xe4d, 0xe5d, 0xe6e, 0xe7e, 0xe8e, 0xe9e, 0xeae, 0xebe, 0xece, 0xede, 0xeee, 0xefe,
         0xf0e, 0xf1e, 0xf2e, 0xf3e, 0xf4e, 0xf5e, 0xf6e, 0xf7f, 0xf8f, 0xf9f, 0xfaf, 0xfbf, 0xfcf, 0xfdf, 0xfef,
         0xfff};

void updateDisplay(const imageData image) {
    // converts 12 bit data into 8-bit data frames (MSPIM), MSB and channel first!
    for (unsigned int l = 0; l < 3; l++) {    // l for Layer
        // first 12bit data needs to be done separately, bc 27 is an odd number
        rawDisplayData[l][0] = L(26 + l * 27) >> 8u;
        rawDisplayData[l][1] = L(26 + l * 27);
        for (unsigned int i = 0; i < 13; i++) {
            unsigned int sendIdx = (i * 3) + 2;    // s: send[]
            unsigned int dataIdx = (25 - (i * 2)) + l * 27;    // d: data[]
            rawDisplayData[l][sendIdx + 0] = L(dataIdx) >> 4u;
            rawDisplayData[l][sendIdx + 1] = (L(dataIdx) << 4u) + (L(dataIdx - 1) >> 8u);
            rawDisplayData[l][sendIdx + 2] = L(dataIdx - 1);
        }
    }
}
